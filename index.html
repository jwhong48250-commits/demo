<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>StarBlast 2D (Phaser)</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.js"></script>
    <style>
      body {
        margin: 0;
        background: black;
      }
      canvas {
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <script>
      class MainScene extends Phaser.Scene {
        constructor() {
          super({ key: "MainScene" });

          this.player = null;
          this.cursors = null;
          this.bullets = null;
          this.enemies = null;

          this.lastFire = 0;
          this.spawnTimer = 0;
          this.spawnRate = 1500;

          this.enemyHp = 1;
          this.score = 0;

          this.playerHp = 100;
          this.scoreText = null;
          this.hpText = null;

          this.playerDirection = { x: 0, y: -1 };
        }

        preload() {
          this.load.image("playerShip", "img/ë‚´ìºë¦­í„°.png");
          this.load.image("enemyShip", "img/ì êµ°.png");

          // ì´ì•Œì€ ìž„ì‹œ ì‚¬ê°í˜• í…ìŠ¤ì²˜
          this.graphicsTexture("bullet", 6, 12, 0xffffff);
        }

        create() {
          // ðŸŸ¦ ìºë¦­í„° í¬ê¸° ì¡°ì • ì—¬ê¸°! (0.5 â†’ 50% í¬ê¸°)
          this.player = this.physics.add
            .sprite(400, 300, "playerShip")
            .setCollideWorldBounds(true)
            .setScale(0.05); // â† ì—¬ê¸° ìˆ«ìžë§Œ ë°”ê¾¸ë©´ ìºë¦­í„° í¬ê¸° ë³€ê²½ë¨

          this.bullets = this.physics.add.group({
            defaultKey: "bullet",
            maxSize: 50,
          });
          this.enemies = this.physics.add.group();

          this.cursors = this.input.keyboard.createCursorKeys();
          this.spaceKey = this.input.keyboard.addKey(
            Phaser.Input.Keyboard.KeyCodes.SPACE
          );

          this.scoreText = this.add.text(10, 10, "Score: 0", {
            fontSize: "24px",
            fill: "#fff",
          });
          this.hpText = this.add.text(10, 40, "HP: 100", {
            fontSize: "24px",
            fill: "#0f0",
          });

          // ì¶©ëŒ ì²˜ë¦¬
          this.physics.add.overlap(
            this.bullets,
            this.enemies,
            this.hitEnemy,
            null,
            this
          );
          this.physics.add.overlap(
            this.player,
            this.enemies,
            this.enemyTouchPlayer,
            null,
            this
          );
        }

        update(time, delta) {
          this.movePlayer();
          this.shoot(time);
          this.spawnEnemies(delta);
          this.moveEnemiesToPlayer();
        }

        movePlayer() {
          const speed = 250;
          this.player.setVelocity(0);

          let dx = 0,
            dy = 0;

          if (this.cursors.left.isDown) dx = -1;
          if (this.cursors.right.isDown) dx = 1;
          if (this.cursors.up.isDown) dy = -1;
          if (this.cursors.down.isDown) dy = 1;

          this.player.setVelocityX(dx * speed);
          this.player.setVelocityY(dy * speed);

          // ë°©í–¥ ì—…ë°ì´íŠ¸ (ì •ì§€ ìƒíƒœì¼ ë•ŒëŠ” íšŒì „ X)
          if (dx !== 0 || dy !== 0) {
            this.playerDirection.x = dx;
            this.playerDirection.y = dy;

            // ì„œìžˆëŠ” ë°°ëŠ” ìƒ(â†‘)ì„ 0ë„ë¡œ ê¸°ì¤€
            const angle = Phaser.Math.RadToDeg(Math.atan2(dy, dx)); // ì¢Œí‘œ â†’ ê°ë„ ë³€í™˜
            this.player.setAngle(angle + 90);
          }
        }

        shoot(time) {
          if (this.spaceKey.isDown && time > this.lastFire) {
            const bullet = this.bullets.get(this.player.x, this.player.y);
            if (bullet) {
              bullet.setActive(true).setVisible(true);

              const speed = 500;
              bullet.body.velocity.x = this.playerDirection.x * speed;
              bullet.body.velocity.y = this.playerDirection.y * speed;

              // ðŸŸ¦ ì´ì•Œ í¬ê¸° ì¡°ì • (ì›í•˜ë©´ ì—¬ê¸° ìˆ˜ì •)
              bullet.setScale(1.0); // â† ì´ì•Œ í¬ê¸°
            }

            this.lastFire = time + 200;
          }

          this.bullets.children.iterate((b) => {
            if (
              b &&
              b.active &&
              (b.y < -10 || b.y > 610 || b.x < -10 || b.x > 810)
            ) {
              b.setActive(false).setVisible(false);
            }
          });
        }

        spawnEnemies(delta) {
          this.spawnTimer += delta;
          if (this.spawnTimer > this.spawnRate) {
            const side = Phaser.Math.Between(1, 4);
            let x, y;

            if (side === 1) {
              x = Phaser.Math.Between(0, 800);
              y = -20;
            } else if (side === 2) {
              x = Phaser.Math.Between(0, 800);
              y = 620;
            } else if (side === 3) {
              x = -20;
              y = Phaser.Math.Between(0, 600);
            } else {
              x = 820;
              y = Phaser.Math.Between(0, 600);
            }

            const enemy = this.enemies.create(x, y, "enemyShip");
            enemy.hp = this.enemyHp;

            // ðŸŸ¥ ì  í¬ê¸° ì¡°ì • ì—¬ê¸°!!
            enemy.setScale(0.4); // â† ì  í¬ê¸° ë°”ê¾¸ëŠ” ê³³

            this.spawnTimer = 0;
            this.spawnRate *= 0.98;
            this.enemyHp = Math.min(this.enemyHp + 0.03, 7);
          }
        }

        moveEnemiesToPlayer() {
          this.enemies.children.iterate((e) => {
            if (!e) return;

            const angle = Phaser.Math.Angle.Between(
              e.x,
              e.y,
              this.player.x,
              this.player.y
            );
            const speed = 80;

            e.setVelocity(Math.cos(angle) * speed, Math.sin(angle) * speed);
          });
        }

        hitEnemy(bullet, enemy) {
          bullet.setActive(false).setVisible(false);
          enemy.hp -= 1;

          if (enemy.hp <= 0) {
            enemy.destroy();
            this.score += 10;
            this.scoreText.setText("Score: " + this.score);
          }
        }

        enemyTouchPlayer(player, enemy) {
          enemy.destroy();

          this.playerHp -= 10;
          this.hpText.setText("HP: " + this.playerHp);

          if (this.playerHp <= 0) {
            this.gameOver();
          }
        }

        gameOver() {
          this.physics.pause();
          this.add.text(250, 280, "GAME OVER", {
            fontSize: "60px",
            fill: "#ff4444",
          });
        }

        graphicsTexture(key, w, h, color) {
          const g = this.make.graphics({ x: 0, y: 0, add: false });
          g.fillStyle(color, 1);
          g.fillRect(0, 0, w, h);
          g.generateTexture(key, w, h);
        }
      }

      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        backgroundColor: "#000011",
        physics: { default: "arcade" },
        scene: MainScene,
      };

      new Phaser.Game(config);
    </script>
  </body>
</html>
